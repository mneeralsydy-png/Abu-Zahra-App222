name: Android CI Build Pro

on:
  push:
    branches: [ "main" ]

jobs:
  build:
    runs-on: ubuntu-latest

    steps:
    - name: Checkout Code
      uses: actions/checkout@v4

    - name: Set up JDK 17
      uses: actions/setup-java@v4
      with:
        java-version: '17'
        distribution: 'temurin'
        cache: gradle

    - name: Auto-locate and Fix Gradle Environment
      run: |
        # البحث عن ملف build.gradle أولاً لمعرفة أين يقع المشروع الحقيقي
        BUILD_FILE=$(find . -name build.gradle | head -n 1)
        PROJECT_ROOT=$(dirname "$BUILD_FILE")
        
        echo "Project detected in: $PROJECT_ROOT"
        
        # الانتقال لمجلد المشروع وإنشاء ملفات التشغيل إذا كانت ناقصة
        cd "$PROJECT_ROOT"
        if [ ! -f gradlew ]; then
          gradle wrapper
        fi
        chmod +x gradlew
        
        # حفظ المسار لاستخدامه
        echo "FINAL_PATH=$PROJECT_ROOT" >> $GITHUB_ENV

    - name: Build with Gradle (Smart Task)
      run: |
        cd ${{ env.FINAL_PATH }}
        # محاولة البناء حتى لو كان المشروع داخل مجلد فرعي
        ./gradlew assembleDebug --stacktrace

    - name: Upload APK
      uses: actions/upload-artifact@v4
      with:
        name: AbuAlZahra-App
        path: "**/build/outputs/apk/debug/*.apk"
