name: Android CI Build (Full Auto-Fix)

on:
  push:
    branches: [ "main" ]

jobs:
  build:
    runs-on: ubuntu-latest

    steps:
    - uses: actions/checkout@v4
    
    - name: Set up JDK 17
      uses: actions/setup-java@v4
      with:
        java-version: '17'
        distribution: 'temurin'

    # ==========================================================
    # === Ø®Ø·ÙˆØ© Ø¥Ù†Ø´Ø§Ø¡ Ø¬Ù…ÙŠØ¹ Ø§Ù„Ù…Ù„ÙØ§Øª Ø§Ù„Ù†Ø§Ù‚ØµØ© ØªÙ„Ù‚Ø§Ø¦ÙŠØ§Ù‹ (Auto-Generate) ===
    # ==========================================================
    
    - name: Generate All Missing Files
      run: |
        
        # 1. Ø¥Ù†Ø´Ø§Ø¡ Ù…Ø¬Ù„Ø¯Ø§Øª Ø§Ù„Ù…Ø´Ø±ÙˆØ¹ Ø§Ù„Ø£Ø³Ø§Ø³ÙŠØ©
        mkdir -p app/src/main/assets
        mkdir -p app/src/main/res/values
        mkdir -p app/src/main/res/xml
        mkdir -p app/src/main/res/layout
        mkdir -p app/src/main/java/com/abuzahra/manager
        
        # 2. Ø¥Ù†Ø´Ø§Ø¡ Ù…Ù„Ù google-services.json (Ø¨ÙŠØ§Ù†Ø§ØªÙƒ Ø§Ù„Ù…Ù‚Ø¯Ù…Ø©)
        cat > app/google-services.json << 'EOF'
        {
          "project_info": {
            "project_number": "787676787951",
            "firebase_url": "https://studio-7073076148-6afe0-default-rtdb.firebaseio.com",
            "project_id": "studio-7073076148-6afe0",
            "storage_bucket": "studio-7073076148-6afe0.firebasestorage.app"
          },
          "client": [
            {
              "client_info": {
                "mobilesdk_app_id": "1:787676787951:android:78bb939f7ab24b0494171a",
                "android_client_info": {
                  "package_name": "com.abuzahra.manager"
                }
              },
              "oauth_client": [
                {
                  "client_id": "787676787951-20uf0a81hb0n5b95t9htb7cd073lu2bm.apps.googleusercontent.com",
                  "client_type": 3
                }
              ],
              "api_key": [
                {
                  "current_key": "AIzaSyASBVIQ0AvrsLqAgbT9k6L7bCpZKoqdvjo"
                }
              ],
              "services": {
                "appinvite_service": {
                  "other_platform_oauth_client": [
                    {
                      "client_id": "787676787951-20uf0a81hb0n5b95t9htb7cd073lu2bm.apps.googleusercontent.com",
                      "client_type": 3
                    }
                  ]
                }
              }
            }
          ],
          "configuration_version": "1"
        }
        EOF

        # 3. Ø¥Ù†Ø´Ø§Ø¡ Ù…Ù„ÙØ§Øª Ø§Ù„Ù…ÙˆØ§Ø±Ø¯ (XML Resources)
        cat > app/src/main/res/values/strings.xml << 'EOF'
        <resources>
            <string name="app_name">Abu Al-Zahra</string>
        </resources>
        EOF

        cat > app/src/main/res/values/styles.xml << 'EOF'
        <resources>
            <style name="Theme.Abualzahra" parent="Theme.MaterialComponents.DayNight.NoActionBar">
                <item name="colorPrimary">#2563EB</item>
                <item name="android:statusBarColor">#0F172A</item>
                <item name="android:navigationBarColor">#0F172A</item>
                <item name="android:windowBackground">#0F172A</item>
            </style>
        </resources>
        EOF

        cat > app/src/main/res/xml/network_security_config.xml << 'EOF'
        <?xml version="1.0" encoding="utf-8"?>
        <network-security-config>
            <base-config cleartextTrafficPermitted="true">
                <trust-anchors>
                    <certificates src="system"/>
                </trust-anchors>
            </base-config>
        </network-security-config>
        EOF

        cat > app/src/main/res/xml/backup_rules.xml << 'EOF'
        <?xml version="1.0" encoding="utf-8"?>
        <full-backup-content>
            <include domain="sharedpref" path="."/>
        </full-backup-content>
        EOF

        cat > app/src/main/res/xml/data_extraction_rules.xml << 'EOF'
        <?xml version="1.0" encoding="utf-8"?>
        <data-extraction-rules>
            <cloud-backup>
                <include domain="sharedpref" path="."/>
            </cloud-backup>
        </data-extraction-rules>
        EOF

        # 4. Ø¥Ù†Ø´Ø§Ø¡ Ù…Ù„Ù Ø§Ù„ÙˆØ§Ø¬Ù‡Ø© (HTML)
        # (Ù„Ù‚Ø¯ Ø¯Ù…Ø¬Øª ÙƒÙˆØ¯ index.html Ù‡Ù†Ø§ Ù„ÙŠØªÙ… Ø¥Ù†Ø´Ø§Ø¤Ù‡ ØªÙ„Ù‚Ø§Ø¦ÙŠØ§Ù‹)
        cat > app/src/main/assets/index.html << 'HTMLEOF'
        <!DOCTYPE html>
        <html lang="ar" dir="rtl">
        <head>
            <meta charset="UTF-8">
            <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
            <title>Abu Al-Zahra Parent</title>
            <script src="https://cdn.tailwindcss.com"></script>
            <link href="https://fonts.googleapis.com/css2?family=Tajawal:wght@400;500;700&display=swap" rel="stylesheet">
            <style>
                body { font-family: 'Tajawal', sans-serif; background-color: #0F172A; color: #E2E8F0; }
                .screen { display: none; position: fixed; inset: 0; flex-direction: column; }
                .screen.active { display: flex; }
                .golden-text-title { font-family: 'Amiri', serif; background: linear-gradient(45deg, #bf953f, #fcf6ba, #b38728); -webkit-background-clip: text; -webkit-text-fill-color: transparent; }
            </style>
        </head>
        <body>
            <!-- 1. Splash -->
            <div id="screen-splash" class="screen active items-center justify-center bg-[#0F172A]">
                <h1 class="text-7xl golden-text-title">Abu Al-Zahra</h1>
                <div class="mt-8 w-8 h-8 border-4 border-blue-500 border-dashed rounded-full animate-spin"></div>
            </div>

            <!-- 2. Login -->
            <div id="screen-login" class="screen items-center justify-center bg-[#0F172A] p-6">
                <div class="w-full max-w-sm text-center space-y-6">
                    <h2 class="text-4xl golden-text-title">Ù…Ø±Ø­Ø¨Ø§Ù‹</h2>
                    <div class="glass-panel rounded-2xl p-6 space-y-3 bg-slate-800 border border-slate-700">
                        <input id="txt-email" type="email" placeholder="Ø§Ù„Ø¨Ø±ÙŠØ¯ Ø§Ù„Ø¥Ù„ÙƒØªØ±ÙˆÙ†ÙŠ" class="w-full bg-white/5 border border-white/10 rounded-xl px-4 py-3 text-white text-sm">
                        <input id="txt-pass" type="password" placeholder="ÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ±" class="w-full bg-white/5 border border-white/10 rounded-xl px-4 py-3 text-white text-sm">
                        <button onclick="handleLogin()" class="w-full bg-blue-600 text-white py-3 rounded-xl font-bold">Ø¯Ø®ÙˆÙ„</button>
                        <button onclick="handleRegister()" class="w-full bg-green-600 text-white py-3 rounded-xl font-bold">Ø¥Ù†Ø´Ø§Ø¡ Ø­Ø³Ø§Ø¨</button>
                        <p id="auth-error" class="text-red-400 text-xs hidden"></p>
                    </div>
                </div>
            </div>

            <!-- 3. Binding -->
            <div id="screen-binding" class="screen items-center justify-center bg-[#0F172A] p-6">
                <div class="text-center w-full max-w-sm">
                    <h2 class="text-2xl text-white font-bold mb-2">Ø±Ø¨Ø· Ø¬Ù‡Ø§Ø² Ø¬Ø¯ÙŠØ¯</h2>
                    <p class="text-gray-400 text-sm mb-6">Ø£Ø¯Ø®Ù„ Ø§Ù„ÙƒÙˆØ¯ ÙÙŠ ØªØ·Ø¨ÙŠÙ‚ Ø§Ù„Ø·ÙÙ„</p>
                    <div class="bg-slate-800 border-2 border-green-500 p-4 rounded-xl mb-6">
                        <p id="display-code" class="text-4xl font-mono text-white font-bold">000 000 000</p>
                    </div>
                    <p id="bind-status" class="text-xs text-gray-500">ÙÙŠ Ø§Ù†ØªØ¸Ø§Ø± Ø§Ù„Ø§ØªØµØ§Ù„...</p>
                </div>
            </div>

            <!-- 4. Dashboard -->
            <div id="screen-main" class="screen bg-[#0F172A]">
                <header class="bg-slate-900/80 border-b p-4 flex justify-between items-center shrink-0">
                    <h1 class="text-lg font-bold text-white">Abu <span class="golden-text-title">Al-Zahra</span></h1>
                    <span class="text-xs text-green-400 bg-green-500/10 px-2 py-1 rounded-full">Ù…ØªØµÙ„</span>
                </header>
                <main class="flex-1 p-4">
                    <div class="bg-slate-800 rounded-2xl p-4 mb-4 flex items-center gap-4">
                        <div class="w-12 h-12 bg-blue-600 rounded-full flex items-center justify-center text-white font-bold">S</div>
                        <div class="flex-1">
                            <h2 class="font-bold text-white">Ø¬Ù‡Ø§Ø² Ø§Ù„Ø·ÙÙ„</h2>
                            <span id="txt-battery" class="text-gray-400 text-xs">85%</span>
                        </div>
                    </div>
                    <div class="grid grid-cols-3 gap-3">
                         <button class="bg-slate-800 rounded-xl p-3 h-24 flex flex-col items-center justify-center">
                             <span class="text-2xl">ğŸ“</span>
                             <span class="text-[10px] text-gray-200 mt-1">Ø§Ù„Ù…ÙˆÙ‚Ø¹</span>
                         </button>
                         <button class="bg-slate-800 rounded-xl p-3 h-24 flex flex-col items-center justify-center">
                             <span class="text-2xl">ğŸ”’</span>
                             <span class="text-[10px] text-gray-200 mt-1">Ù‚ÙÙ„</span>
                         </button>
                         <button class="bg-slate-800 rounded-xl p-3 h-24 flex flex-col items-center justify-center">
                             <span class="text-2xl">ğŸ“±</span>
                             <span class="text-[10px] text-gray-200 mt-1">ØªØ·Ø¨ÙŠÙ‚Ø§Øª</span>
                         </button>
                    </div>
                </main>
            </div>

            <script>
                function callNative(fn, arg) {
                    if (typeof AndroidNative !== 'undefined') {
                        if (arg) AndroidNative[fn](arg); else AndroidNative[fn]();
                    }
                }

                function showScreen(id) {
                    document.querySelectorAll('.screen').forEach(s => s.classList.remove('active'));
                    document.getElementById(id).classList.add('active');
                }

                function handleLogin() {
                    const email = document.getElementById('txt-email').value;
                    const pass = document.getElementById('txt-pass').value;
                    if(!email || !pass) return;
                    callNative('loginUser', JSON.stringify({email: email, pass: pass}));
                }

                function handleRegister() {
                    const email = document.getElementById('txt-email').value;
                    const pass = document.getElementById('txt-pass').value;
                    if(!email || !pass) return;
                    callNative('registerUser', JSON.stringify({email: email, pass: pass}));
                }

                window.onAuthSuccess = function(uid) {
                    showScreen('screen-binding');
                    const code = Math.floor(100000000 + Math.random() * 900000000);
                    const formatted = code.toString().substring(0,3) + " " + code.toString().substring(3,6) + " " + code.toString().substring(6);
                    document.getElementById('display-code').innerText = formatted;
                    callNative('startListeningForChild', code.toString());
                };

                window.onAuthError = function(msg) {
                    document.getElementById('auth-error').innerText = msg;
                    document.getElementById('auth-error').classList.remove('hidden');
                };

                window.onChildLinked = function() {
                    showScreen('screen-main');
                };
            </script>
        </body>
        </html>
        HTMLEOF

        # 5. Ø¥Ù†Ø´Ø§Ø¡ Ù…Ù„Ù Layout
        cat > app/src/main/res/layout/activity_main.xml << 'EOF'
        <?xml version="1.0" encoding="utf-8"?>
        <RelativeLayout xmlns:android="http://schemas.android.com/apk/res/android"
            android:layout_width="match_parent"
            android:layout_height="match_parent"
            android:background="#0F172A">
            <WebView
                android:id="@+id/webview"
                android:layout_width="match_parent"
                android:layout_height="match_parent" />
        </RelativeLayout>
        EOF

        # 6. Ø¥Ù†Ø´Ø§Ø¡ Ù…Ù„ÙØ§Øª Kotlin (Ù…Ø¹ Ø¥ØµÙ„Ø§Ø­ Ù…Ø´ÙƒÙ„Ø© private)
        cat > app/src/main/java/com/abuzahra/manager/MainActivity.kt << 'EOF'
        package com.abuzahra.manager

        import android.os.Bundle
        import android.webkit.WebSettings
        import android.webkit.WebView
        import android.webkit.WebViewClient
        import androidx.appcompat.app.AppCompatActivity

        class MainActivity : AppCompatActivity() {
            lateinit var webView: WebView // ØªÙ… Ø¥Ø²Ø§Ù„Ø© private Ù„Ø­Ù„ Ø§Ù„Ù…Ø´ÙƒÙ„Ø©

            override fun onCreate(savedInstanceState: Bundle?) {
                super.onCreate(savedInstanceState)
                setContentView(R.layout.activity_main)
                webView = findViewById(R.id.webview)
                setupWebView()
            }

            private fun setupWebView() {
                val webSettings: WebSettings = webView.settings
                webSettings.javaScriptEnabled = true
                webSettings.domStorageEnabled = true
                webSettings.allowFileAccess = true
                webView.addJavascriptInterface(WebAppInterface(this), "AndroidNative")
                webView.webViewClient = WebViewClient()
                webView.loadUrl("file:///android_asset/index.html")
            }
        }
        EOF

        cat > app/src/main/java/com/abuzahra/manager/WebAppInterface.kt << 'EOF'
        package com.abuzahra.manager

        import android.content.Context
        import android.webkit.JavascriptInterface
        import com.google.firebase.auth.FirebaseAuth
        import com.google.firebase.firestore.FirebaseFirestore
        import kotlinx.coroutines.CoroutineScope
        import kotlinx.coroutines.Dispatchers
        import kotlinx.coroutines.launch
        import kotlinx.coroutines.tasks.await
        import org.json.JSONObject

        class WebAppInterface(private val mContext: Context) {
            private val auth = FirebaseAuth.getInstance()
            private val db = FirebaseFirestore.getInstance()
            private var listenerRegistration: com.google.firebase.firestore.ListenerRegistration? = null

            @JavascriptInterface
            fun loginUser(jsonData: String) {
                val data = JSONObject(jsonData)
                val email = data.getString("email")
                val pass = data.getString("pass")
                CoroutineScope(Dispatchers.IO).launch {
                    try {
                        auth.signInWithEmailAndPassword(email, pass).await()
                        sendResultToUI("window.onAuthSuccess('${auth.currentUser?.uid}')")
                    } catch (e: Exception) {
                        sendResultToUI("window.onAuthError('${e.message}')")
                    }
                }
            }

            @JavascriptInterface
            fun registerUser(jsonData: String) {
                val data = JSONObject(jsonData)
                val email = data.getString("email")
                val pass = data.getString("pass")
                CoroutineScope(Dispatchers.IO).launch {
                    try {
                        auth.createUserWithEmailAndPassword(email, pass).await()
                        sendResultToUI("window.onAuthSuccess('${auth.currentUser?.uid}')")
                    } catch (e: Exception) {
                        sendResultToUI("window.onAuthError('${e.message}')")
                    }
                }
            }

            @JavascriptInterface
            fun startListeningForChild(code: String) {
                val uid = auth.currentUser?.uid ?: return
                val codeRef = db.collection("linking_codes").document(code)
                val codeData = hashMapOf("parent_uid" to uid, "status" to "active")
                CoroutineScope(Dispatchers.IO).launch { codeRef.set(codeData).await() }
                
                listenerRegistration = db.collection("parents").document(uid).collection("children")
                    .addSnapshotListener { snapshot, e ->
                        if (e != null || snapshot == null) return@addSnapshotListener
                        if (!snapshot.isEmpty) {
                            listenerRegistration?.remove()
                            sendResultToUI("window.onChildLinked()")
                        }
                    }
            }

            private fun sendResultToUI(jsCode: String) {
                CoroutineScope(Dispatchers.Main).launch {
                    (mContext as MainActivity).webView.evaluateJavascript(jsCode, null)
                }
            }
        }
        EOF

    # === Ø§Ù„Ø¨Ù†Ø§Ø¡ ===
    - name: Install Gradle 8.5
      run: |
        curl -L https://services.gradle.org/distributions/gradle-8.5-bin.zip -o gradle-8.5-bin.zip
        unzip gradle-8.5-bin.zip
        echo "$PWD/gradle-8.5/bin" >> $GITHUB_PATH

    - name: Grant execute permission for gradlew
      run: chmod +x gradlew
      
    - name: Build with Gradle
      run: ./gradlew :app:assembleDebug
      
    - name: Upload APK Artifact
      uses: actions/upload-artifact@v4
      with:
        name: AbuAlZahra-Parent-App
        path: app/build/outputs/apk/debug/app-debug.apk
